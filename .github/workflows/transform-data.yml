name: Transform and Upload Data to S3

on:
  repository_dispatch:
    types: [data_updated]  # Listening for the custom event

jobs:
  transform_and_upload:
    runs-on: ubuntu-latest

    steps:
      # Checkout the latest version of the application repository
      - name: Checkout repository
        uses: actions/checkout@v2

      # Checkout the latest version of the data repository
      - name: Checkout data repository
        uses: actions/checkout@v2
        with:
          repository: srophe/syriaca-data
          path: ./data-repo

      # Set up Java (required to run Saxon)
      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'

      # Download Saxon from GitHub
      - name: Download Saxon from GitHub
        run: |
          wget https://repo1.maven.org/maven2/net/sf/saxon/Saxon-HE/10.6/Saxon-HE-10.6.jar -O saxon.jar

      # Run XSLT Transformations
      - name: Run XSLT Transformations
        run: |
          for file in $(find . -name '*.xml'); do
            echo "Processing $file"
            java -jar saxon.jar -s:$file -xsl:siteGenerator/xsl/json.xsl -o:${file%.xml}.json
          done

      # Configure AWS credentials
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      # Upload JSON to S3
      - name: Upload JSON to S3
        run: |
          aws s3 cp output/ s3://srophe-syriaca-front-end/json-data/ --recursive --exclude "*" --include "*.json"
        env:
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
          
      
